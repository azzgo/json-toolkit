name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write  # Required for creating releases and uploading assets

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
          
      - name: Install dependencies
        run: bun install
        
      - name: Build toolkit web version
        run: bun run toolkit:build
        
      - name: Build toolkit for extension
        run: bun run toolkit:build:extension
        
      - name: Build Chrome extension
        run: bun run ext:build:chrome
        
      - name: Build Firefox extension
        run: bun run ext:build:firefox
        
      - name: Create Chrome extension zip
        run: |
          cd packages/extension
          bun run zip:chrome
          
      - name: Create Firefox extension zip
        run: |
          cd packages/extension
          bun run zip:firefox
          
      - name: Create web toolkit archive
        run: |
          cd packages/toolkit/dist
          tar -czf ../../../json-toolkit-web.tar.gz *
          
      - name: Get version from tag
        id: get_version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=dev-$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
          fi
          
      - name: Prepare extension files for release
        run: |
          echo "Preparing extension files..."
          
          # List all files in extension output directory for debugging
          echo "Extension output directory contents:"
          ls -la packages/extension/.output/
          
          # Find and rename extension zip files
          CHROME_ZIP=$(find packages/extension/.output -name "*chrome*.zip" | head -1)
          FIREFOX_ZIP=$(find packages/extension/.output -name "*firefox*.zip" -not -name "*sources*" | head -1)
          
          if [ -n "$CHROME_ZIP" ] && [ -f "$CHROME_ZIP" ]; then
            cp "$CHROME_ZIP" "./json-toolkit-chrome.zip"
            echo "âœ“ Chrome extension: $(basename "$CHROME_ZIP") â†’ json-toolkit-chrome.zip"
          else
            echo "âŒ Chrome extension zip not found"
            exit 1
          fi
          
          if [ -n "$FIREFOX_ZIP" ] && [ -f "$FIREFOX_ZIP" ]; then
            cp "$FIREFOX_ZIP" "./json-toolkit-firefox.zip"
            echo "âœ“ Firefox extension: $(basename "$FIREFOX_ZIP") â†’ json-toolkit-firefox.zip"
          else
            echo "âŒ Firefox extension zip not found"
            exit 1
          fi
          
          # Verify web toolkit archive exists
          if [ ! -f "json-toolkit-web.tar.gz" ]; then
            echo "âŒ Web toolkit archive not found"
            exit 1
          fi
          
          echo "âœ“ All files prepared for release"
          
      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        if: github.ref_type == 'tag'
        with:
          tag_name: ${{ steps.get_version.outputs.VERSION }}
          name: JSON Toolkit ${{ steps.get_version.outputs.VERSION }}
          draft: true
          prerelease: false
          body: |
            ## JSON Toolkit ${{ steps.get_version.outputs.VERSION }}
            
            ### ğŸ“¦ ä¸‹è½½è¯´æ˜
            
            - **Chrome æ‰©å±•**: ä¸‹è½½ `json-toolkit-chrome.zip`ï¼Œè§£å‹ååœ¨ Chrome æ‰©å±•ç®¡ç†é¡µé¢åŠ è½½
            - **Firefox æ‰©å±•**: ä¸‹è½½ `json-toolkit-firefox.zip`ï¼Œè§£å‹ååœ¨ Firefox æ’ä»¶ç®¡ç†é¡µé¢å®‰è£…
            - **Web ç‰ˆæœ¬**: ä¸‹è½½ `json-toolkit-web.tar.gz`ï¼Œè§£å‹åéƒ¨ç½²åˆ° Web æœåŠ¡å™¨
            
            ### âœ¨ åŠŸèƒ½ç‰¹ç‚¹
            
            - ğŸ”§ æ™ºèƒ½ JSON ç¼–è¾‘å™¨ - å¤šè§†å›¾æ¨¡å¼ï¼Œè¯­æ³•é«˜äº®ï¼Œæ ¼å¼åŒ–å·¥å…·
            - ğŸ” JWT ä»¤ç‰Œè§£ç å™¨ - å®Œæ•´è§£æï¼Œç­¾åéªŒè¯ï¼Œåˆ°æœŸæ—¶é—´æ£€æŸ¥
            - âš¡ ä»£ç ç”Ÿæˆå™¨ - å¤šè¯­è¨€æ”¯æŒï¼Œç±»å‹å®‰å…¨ï¼Œå³æ—¶é¢„è§ˆ
            - ğŸ”„ JSON å·®å¼‚å¯¹æ¯” - å¹¶æ’å¯¹æ¯”ï¼Œé«˜äº®æ˜¾ç¤ºå·®å¼‚
            - ğŸ² æ™ºèƒ½ Mock æ•°æ®ç”Ÿæˆå™¨ - æ™ºèƒ½å­—æ®µè¯†åˆ«ï¼Œä¸°å¯Œæ•°æ®ç±»å‹
            - ğŸ”§ URL å‚æ•°è½¬æ¢å™¨ - åŒå‘è½¬æ¢ï¼Œç¼–ç å¤„ç†
            - ğŸŒ æµè§ˆå™¨é›†æˆ - å³é”®ä¸Šä¸‹æ–‡èœå•ï¼Œæ™ºèƒ½ JSON ä¿®å¤
            
            ### ğŸš€ å®‰è£…æŒ‡å—
            
            #### Chrome/Edge å®‰è£…
            1. ä¸‹è½½ `json-toolkit-chrome.zip`
            2. æ‰“å¼€ Chrome æ‰©å±•ç®¡ç†é¡µé¢ (`chrome://extensions/`)
            3. å¼€å¯å³ä¸Šè§’çš„ "å¼€å‘è€…æ¨¡å¼"
            4. ç‚¹å‡» "åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº"ï¼Œé€‰æ‹©è§£å‹åçš„æ–‡ä»¶å¤¹
            
            #### Firefox å®‰è£…
            1. ä¸‹è½½ `json-toolkit-firefox.zip`
            2. æ‰“å¼€ Firefox æ’ä»¶ç®¡ç†é¡µé¢ (`about:addons`)
            3. ç‚¹å‡»è®¾ç½®å›¾æ ‡ï¼Œé€‰æ‹© "ä»æ–‡ä»¶å®‰è£…æ’ä»¶"
            4. é€‰æ‹©ä¸‹è½½çš„ `.zip` æ–‡ä»¶
            
            #### Web ç‰ˆæœ¬éƒ¨ç½²
            1. ä¸‹è½½ `json-toolkit-web.tar.gz`
            2. è§£å‹åˆ°ä½ çš„ Web æœåŠ¡å™¨ç›®å½•
            3. è®¿é—® `index.html` å³å¯ä½¿ç”¨
            
            ---
            
            **å®Œæ•´æ›´æ–°æ—¥å¿—å’ŒæŠ€æœ¯ç»†èŠ‚è¯·æŸ¥çœ‹é¡¹ç›® README**
          files: |
            json-toolkit-chrome.zip
            json-toolkit-firefox.zip
            json-toolkit-web.tar.gz

